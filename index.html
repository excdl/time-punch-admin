<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>奇可智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; background:#f5f6fa; margin:0; padding:20px; display:flex; justify-content:center;}
#controlPanel { background:white; padding:25px 20px; border-radius:15px; box-shadow:0 8px 20px rgba(0,0,0,0.1); width:95%; max-width:500px; display:flex; flex-direction:column; gap:20px; align-items:center; }
#userInfo { text-align:center; font-size:26px; font-weight:bold; }
#statusInfo { text-align:center; font-size:23px; padding:5px 15px; border-radius:20px; display:inline-block; }
#dateTime { text-align:center; font-size:22px; }
.buttons-container { display:flex; gap:10px; width:100%; flex-wrap:nowrap; }
.buttons-container button { flex:1 1 0; min-width:80px; padding:10px 0; font-size:25px; border-radius:8px; cursor:pointer; font-weight:bold; border:none; white-space:nowrap; transition: all 0.2s ease;}
.buttons-container button:hover{transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1);}
.buttons-container button:active{transform: translateY(1px); box-shadow: 0 2px 4px rgba(0,0,0,0.08);}
#btnStart { background: linear-gradient(145deg, #3498db, #2980b9); color:white; } 
#btnEnd { background: linear-gradient(145deg, #2ecc71, #27ae60); color:white; }   
#querySection { width:100%; display:flex; flex-direction:column; gap:10px; }
#querySection .queryRow { display:flex; gap:10px; width:100%; flex-wrap:nowrap; align-items:center;}
#querySection input[type="date"] { flex:1 1 auto; min-width:100px; padding:8px 10px; font-size:14px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
#querySection button { flex:1 1 0; padding:8px 0; font-size:14px; font-weight:bold; border-radius:6px; border:none; cursor:pointer; white-space:nowrap;}
#btnQuery { background:#d3d3d3; color:black; }  
#btnReturn { background:#d3d3d3; color:black; }  
#todayRecords { border:1px solid #ccc; border-radius:8px; padding:10px; min-height:50px; font-size:16px; background: #fafafa; width:100%; box-sizing:border-box;}
#adminPanel { display:none; width:100%; margin-top:20px; text-align:center;}
#recordsTable { width:100%; border-collapse: collapse; margin-top:10px;}
#recordsTable th, #recordsTable td { border:1px solid #ccc; padding:5px; font-size:14px;}
</style>
</head>
<body>

<div id="controlPanel">
  <div id="userInfo">載入中...</div>
  <div id="statusInfo"></div>
  <div id="dateTime">載入中…</div>

  <div class="buttons-container">
    <button id="btnStart">上班</button>
    <button id="btnEnd">下班</button>
  </div>

  <div id="querySection">
    <div class="queryRow">
      <input type="date" id="queryDate">
      <button id="btnQuery" onclick="searchDateRecords()">查詢</button>
      <button id="btnReturn" onclick="clearSearch()">返回</button>
    </div>
    <div id="todayRecords">今日打卡紀錄：</div>
  </div>

  <div id="adminPanel">
    <h3>管理員打卡查詢</h3>
    <label>日期：<input type="date" id="adminQueryDate"></label>
    <button onclick="queryRecords()">查詢</button>
    <button onclick="downloadCSV()">下載 CSV</button>
    <table id="recordsTable">
      <thead>
        <tr><th>帳號</th><th>姓名</th><th>日期</th><th>時間</th><th>狀態</th><th>IP</th><th>補打卡</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbwcE0gyMl-Cb-Cim8y2So9a76-UXJdMU3nC5sqiXz6a0V49waXAFKo5sMpl3-AbQkovQg/exec";  // 請換成 GAS 部署網址
let COMPANY_IPS = [];

function updateDateTime() { document.getElementById("dateTime").textContent = new Date().toLocaleString("zh-TW",{hour12:false});}
setInterval(updateDateTime,1000); updateDateTime();

async function getIP() {
  const cache = sessionStorage.getItem("myIP");
  if(cache) return cache;
  try { const res = await fetch("https://api.ipify.org?format=json"); const data = await res.json(); sessionStorage.setItem("myIP", data.ip); return data.ip;} catch { return ""; }
}

async function updateUserInfo(){
  await liff.init({liffId:"2008549731-Zkv32GPr"});
  if(!liff.isLoggedIn()) await liff.login();
  const profile = await liff.getProfile();
  const ip = await getIP();
  window.userId = profile.userId;
  window.userName = profile.displayName;
  document.getElementById("userInfo").textContent=`${window.userName} 您好`;

  // 取得公司 IP
  const res = await fetch(API_ENDPOINT+"?action=getAdminIP");
  COMPANY_IPS = await res.json();

  const s = document.getElementById("statusInfo");
  const isCompany = COMPANY_IPS.includes(ip);
  s.textContent = isCompany?"公司網路":"非公司網路";
  s.style.color = isCompany?"#008000":"#FF0000";
  s.style.backgroundColor=isCompany?"rgba(144,238,144,0.6)":"rgba(255,182,193,0.3)";
  s.style.padding="5px 15px"; s.style.borderRadius="20px"; s.style.display="inline-block"; s.style.fontWeight="bold";

  // 啟用打卡按鈕
  document.getElementById("btnStart").disabled=false;
  document.getElementById("btnEnd").disabled=false;

  // 管理員判斷
  const adminRes = await fetch(API_ENDPOINT+"?action=getAdminAccount&userId="+window.userId);
  const adminData = await adminRes.json();
  if(adminData.length>0) document.getElementById("adminPanel").style.display="block";
}

document.addEventListener("DOMContentLoaded", async()=>{ await updateUserInfo(); await updateTodayRecords(); });

async function performClockIn(status){
  const ip = await getIP();
  const res = await fetch(API_ENDPOINT,{
    method:"POST",
    body: JSON.stringify({userId:window.userId, displayName:window.userName, status, ip})
  });
  const data = await res.json();
  Swal.fire({title:data.message, timer:1500, showConfirmButton:false});
  updateTodayRecords();
}

document.getElementById("btnStart").onclick=()=>performClockIn("上班");
document.getElementById("btnEnd").onclick=()=>performClockIn("下班");

function clearSearch(){ document.getElementById("queryDate").value=""; updateTodayRecords(); }

async function updateTodayRecords(){
  const today = new Date().toISOString().slice(0,10).replace(/-/g,"/");
  const res = await fetch(`${API_ENDPOINT}?action=getDate&userId=${window.userId}&date=${today}`);
  const data = await res.json();
  const container = document.getElementById("todayRecords");
  if(!data.length){ container.innerHTML="今日打卡紀錄：無"; return; }
  container.innerHTML="今日打卡紀錄：<br>"+data.map(r=>`${r.status} ${r.time} ${COMPANY_IPS.includes(r.ip)?"公司網路":"異地"} ${r.isMakeup?"(補打卡)":""}`).join("<br>");
}

async function searchDateRecords(){
  const date = document.getElementById("queryDate").value;
  if(!date){ updateTodayRecords(); return; }
  const dateStr = date.replace(/-/g,"/");
  const res = await fetch(`${API_ENDPOINT}?action=getDate&userId=${window.userId}&date=${dateStr}`);
  const data = await res.json();
  const container = document.getElementById("todayRecords");
  if(!data.length){ container.innerHTML=`${dateStr}：無紀錄`; return; }
  container.innerHTML=`${dateStr} 打卡紀錄：<br>`+data.map(r=>`${r.status} ${r.time} ${COMPANY_IPS.includes(r.ip)?"公司網路":"異地"} ${r.isMakeup?"(補打卡)":""}`).join("<br>");
}

// ===== 管理員查詢 =====
async function queryRecords(){
  const date = document.getElementById("adminQueryDate").value;
  const res = await fetch(API_ENDPOINT+"?action=getAll&date="+date);
  const data = await res.json();
  const tbody = document.getElementById("recordsTable").querySelector("tbody");
  tbody.innerHTML="";
  data.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${r.userId}</td><td>${r.userName}</td><td>${r.date}</td><td>${r.time}</td><td>${r.status}</td><td>${r.ip}</td><td>${r.isMakeup?"是":""}</td>`;
    tbody.appendChild(tr);
  });
}

function downloadCSV(){
  const rows = Array.from(document.getElementById("recordsTable").querySelectorAll("tr"));
  let csvContent = rows.map(r=>Array.from(r.querySelectorAll("th,td")).map(c=>`"${c.innerText}"`).join(",")).join("\n");
  const blob = new Blob([csvContent], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="打卡紀錄.csv"; a.click(); URL.revokeObjectURL(url);
}
</script>

</body>
</html>
